<?php

/**
 * @file
 * Panelizer Variant Module File.
 */

require_once 'includes/panelizer_variant.custom.inc';

/**
 * Implements hook_form_FORM_ID_alter().
 */
function panelizer_variant_form_panelizer_default_context_form_alter(&$form, &$form_state, $form_id) {
  if ($form_state['panelizer']->title != "Default") {
    $form['right']['variant'] = array(
      '#weight' => -1,
    );

    $form['right']['variant']['use_variant'] = array(
      '#markup' => t('<p><strong>NOTE: YOU MUST SELECT A CONTEXT</strong></p>'),
      '#prefix' => '<div id="ctools-variant-table"><table id="variant-table"><thead><tr><th class="title">Variant Info</th></tr></thead><tbody><tr><td>',
      '#suffix' => '</td></tr></tbody></table></div>',
    );

    $form['#validate'][] = '_panelizer_variant_custom_validate';
    $form['#submit'][] = '_panelizer_variant_custom_submit';
  }
}

/**
 * Custom Validator for form.
 */
function _panelizer_variant_custom_validate($form, &$form_state) {
  if (!isset($form_state['panelizer']->contexts[0])) {
    form_set_error('right][variant',
      t('You must select a context when using a Variant View Mode'));
  }
}

/**
 * Custom SUBMIT for form.
 */
function _panelizer_variant_custom_submit($form, &$form_state) {

  $did = $form_state['panelizer']->did;
  $name = $form_state['panelizer']->name;
  $eid = $form_state['panelizer']->contexts[0]['entity_id'];

  // Write to panelizer_entity so it grabs it automitically later on.
  $data = array(
    'entity_type' => 'page',
    'entity_id' => $eid,
    'revision_id' => $eid,
    'name' => $name,
    'no_blocks' => $form_state['panelizer']->no_blocks,
    'pipeline' => $form_state['panelizer']->pipeline,
    'contexts' => $form_state['panelizer']->contexts,
    'relationships' => $form_state['panelizer']->relationships,
    'did' => $did,
  );
  $exist = db_query('SELECT entity_id FROM {panelizer_entity} WHERE did = :did', array(':did' => $did))->rowCount();
  if ($exist > 0) {
    drupal_write_record('panelizer_entity', $data, 'entity_id');
  }
  else {
    drupal_write_record('panelizer_entity', $data);
  }

  // Write to panelizer_variant so we can manipulate the entity_load
  $values = array();
  foreach ($form_state['panelizer']->contexts as $key) {
    $values[] = array(
      'name' => $key['keyword'],
      'entity_id' => $key['entity_id'],
    );
  }
  $data_var = array(
    'name' => $name,
    'context' => $values,
    'did' => $did,
    'entity_id' => $eid,
  );
  $exist_var = db_query('SELECT name FROM {panelizer_variant} WHERE name = :name', array(':name' => $name))->rowCount();
  if ($exist_var > 0) {
    drupal_write_record('panelizer_variant', $data_var, 'name');
  }
  else {
    drupal_write_record('panelizer_variant', $data_var);
  }
}

/**
 * Implements hook_entity_view_mode_alter().
 */
function panelizer_variant_entity_view_mode_alter(&$view_mode, $context) {
  //dpm($context['entity']->panelizer);
  dpm($context);
  if ($entity['panelized'] && isset($entity['view_mode'])) {
    $view_mode = $entity['view_mode'];
  }
}

function panelizer_variant_entity_load(&$entities, $entity_type) {
  $entity_get = _panelizer_variant_entity_render($entities);

  /* This is almost there but not quite right, I think I need to take my $entity_get and load it into $entities
  * then reload this entity somehow, i think the last 2 things do it, but I am missing something here
  * maybe look and see how panelizer does it for a node override.
  */

  // foreach ($entities as $entity => $value) {
  //   if (isset($value->panelizer)) {
  //     foreach ($value->panelizer as $panel => $match) {
  //       $match->name = $entity_get->name;
  //       $match->did = $entity_get->did;
  //       $match->entity_id = $entity_get->entity_id;
  //     }
  //   }
  // }

  // $handler = panelizer_entity_plugin_get_handler($entity_type);
  // $handler->hook_entity_load($entities);
}
