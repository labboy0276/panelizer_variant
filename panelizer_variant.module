<?php

/**
 * @file
 * Panelizer Variant Module File.
 */

require_once 'includes/panelizer_variant.custom.inc';

/**
 * Implements hook_form_FORM_ID_alter().
 */
function panelizer_variant_form_panelizer_default_context_form_alter(&$form, &$form_state, $form_id) {
  if ($form_state['panelizer']->title != "Default") {
    $form['right']['variant'] = array(
      '#weight' => -1,
    );

    $form['right']['variant']['use_variant'] = array(
      '#markup' => t('<p><strong>NOTE: YOU MUST SELECT A CONTEXT</strong></p>'),
      '#prefix' => '<div id="ctools-variant-table"><table id="variant-table"><thead><tr><th class="title">Variant Info</th></tr></thead><tbody><tr><td>',
      '#suffix' => '</td></tr></tbody></table></div>',
    );

    // Remove all but Taxonomy term for now from select list.
    $form['right']['contexts_table']['buttons']['context']['item']['#options'] = array(
      t('entity:taxonomy_term') => t('Taxonomy term'),
    );

    $form['#validate'][] = '_panelizer_variant_custom_validate';
    $form['#submit'][] = '_panelizer_variant_custom_submit';
  }
}

/**
 * Custom Validator for form.
 */
function _panelizer_variant_custom_validate($form, &$form_state) {
  if (!isset($form_state['panelizer']->contexts[0])) {
    form_set_error('right][variant',
      t('You must select a context when using a Variant View Mode'));
  }
}

/**
 * Custom SUBMIT for form.
 */
function _panelizer_variant_custom_submit($form, &$form_state) {

  $did = $form_state['panelizer']->did;
  $name = $form_state['panelizer']->name;
  $pnid = $form_state['panelizer']->pnid;

  // Write to panelizer_variant so we can manipulate the entity_load
  $values = array();
  foreach ($form_state['panelizer']->contexts as $key) {
    $values[] = array(
      'name' => $key['keyword'],
      'entity_id' => $key['entity_id'],
    );
  }
  $data_var = array(
    'pnid' => $pnid,
    'name' => $name,
    'context' => $values,
    'did' => $did,
    'view_mode' => 'page_manager',
  );
  $exist_var = db_query('SELECT pnid FROM {panelizer_variant} WHERE pnid = :pnid', array(':pnid' => $pnid))->rowCount();
  if ($exist_var > 0) {
    drupal_write_record('panelizer_variant', $data_var, 'name');
  }
  else {
    drupal_write_record('panelizer_variant', $data_var);
  }
}

/**
 * Implements hook_entity_load().
 */
function panelizer_variant_entity_load(&$entities, $entity_type) {
  if ($entity_type == 'node') {
    $entity_get = _panelizer_variant_entity_render($entities);
    // I like the foreach loop I wrote here but I can't get it to save the values.
    // So I did it below this. This all works though.


    // foreach ($entities as $entity => $value) {
    //   if (isset($value->panelizer)) {
    //     foreach ($value->panelizer as $panelizer) {
    //       foreach ($panelizer as $keyorig => $valueorig) {
    //         foreach ($entity_get as $keymatch => $valuematch) {
    //           if ($keyorig == $keymatch) {
    //             $entities[$enitity]->panelizer['page_manager']->$keyorig = $valuematch;
    //           }
    //         }
    //       }
    //     }
    //   }
    // }

    foreach ($entities as $entity) {
      if (isset($entity->panelizer) && (count($entity_get) > 0)) {
        $entity->panelizer['page_manager']->name = $entity_get['name'];
        $entity->panelizer['page_manager']->pnid = $entity_get['pnid'];
        $entity->panelizer['page_manager']->title = $entity_get['title'];
        $entity->panelizer['page_manager']->panelizer_type = $entity_get['panelizer_type'];
        $entity->panelizer['page_manager']->panelizer_key = $entity_get['panelizer_key'];
        $entity->panelizer['page_manager']->no_blocks = $entity_get['no_blocks'];
        $entity->panelizer['page_manager']->css_id = $entity_get['css_id'];
        $entity->panelizer['page_manager']->css = $entity_get['css'];
        $entity->panelizer['page_manager']->pipeline = $entity_get['pipeline'];
        $entity->panelizer['page_manager']->contexts = $entity_get['contexts'];
        $entity->panelizer['page_manager']->relationships = $entity_get['relationships'];
        $entity->panelizer['page_manager']->did = $entity_get['did'];
        $entity->panelizer['page_manager']->access = $entity_get['access'];
        $entity->panelizer['page_manager']->view_mode = $entity_get['view_mode'];
        $entity->panelizer['page_manager']->css_class = $entity_get['css_class'];
        $entity->panelizer['page_manager']->title_element = $entity_get['title_element'];
        $entity->panelizer['page_manager']->link_to_entity = $entity_get['link_to_entity'];
        $entity->panelizer['page_manager']->extra = $entity_get['extra'];
        unset($entity->panelizer['page_manager']->display);
        $entity->panelizer['page_manager']->display = $entity_get['display'];
      }
    }
  }
}
